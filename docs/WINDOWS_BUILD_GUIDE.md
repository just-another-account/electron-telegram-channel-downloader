# Windows 构建指南

## 问题描述

在Windows平台上打包Electron应用时，可能会遇到双击无响应的问题。这通常是由于路径处理、资源加载或权限配置问题导致的。

## 解决方案

### 1. 使用优化的构建脚本

我们提供了专门的Windows构建脚本，使用以下命令：

```bash
# 使用优化的Windows构建脚本
pnpm run build:win

# 或者使用简单的构建命令
pnpm run build:win-simple
```

### 2. 主要优化内容

#### 2.1 Package.json 优化
- 添加了 `homepage: "./"` 确保资源路径正确
- 优化了文件包含策略，排除不必要的node_modules
- 配置了Windows特定的目标和架构
- 添加了NSIS安装程序配置

#### 2.2 Electron主进程优化
- 改进了路径处理逻辑，支持打包后的资源路径
- 添加了单实例应用支持
- 增强了错误处理和日志记录
- 添加了Windows特定的启动参数
- 改进了窗口创建和显示逻辑

#### 2.3 Vite配置优化
- 配置了正确的base路径
- 优化了打包输出文件命名
- 添加了依赖优化配置
- 改进了CSS处理

#### 2.4 NSIS安装程序
- 创建了自定义安装脚本
- 配置了正确的权限级别
- 添加了文件关联和快捷方式创建

### 3. 构建流程

#### 3.1 环境检查
```bash
# 确保Node.js版本 >= 18
node --version

# 确保已安装依赖
pnpm install
```

#### 3.2 清理和构建
```bash
# 清理旧的构建文件
rm -rf dist dist-electron

# 运行Windows构建
pnpm run build:win
```

#### 3.3 测试构建结果
1. 检查 `dist-electron` 目录
2. 找到 `.exe` 安装程序
3. 在Windows机器上安装并测试

### 4. 常见问题和解决方案

#### 4.1 双击无响应
**原因**: 资源路径错误或主进程启动失败
**解决**: 
- 检查 `electron/main.js` 中的路径处理
- 确保 `dist/index.html` 存在且正确
- 查看任务管理器中是否有进程启动

#### 4.2 白屏问题
**原因**: 前端资源加载失败
**解决**:
- 检查 `vite.config.js` 中的 `base` 配置
- 确保相对路径正确
- 检查控制台错误信息

#### 4.3 权限问题
**原因**: Windows权限限制
**解决**:
- 使用 `requestedExecutionLevel: "asInvoker"`
- 避免需要管理员权限的操作
- 检查文件路径权限

#### 4.4 图标显示问题
**原因**: 图标文件路径或格式问题
**解决**:
- 确保 `build/icon.ico` 存在
- 检查图标文件格式和大小
- 验证路径引用正确

### 5. 调试方法

#### 5.1 启用调试模式
在开发环境中测试：
```bash
pnpm run dev
```

#### 5.2 查看日志
- 检查控制台输出
- 查看 `%APPDATA%\telegram-channel-downloader\logs` 目录
- 使用 `DEBUG=electron-builder` 环境变量

#### 5.3 手动测试
```bash
# 构建但不打包
pnpm run build:dir

# 手动运行electron
npx electron dist-electron
```

### 6. 最佳实践

1. **使用相对路径**: 确保所有资源使用相对路径
2. **错误处理**: 添加完善的错误处理和日志
3. **权限最小化**: 避免使用管理员权限
4. **测试覆盖**: 在不同Windows版本上测试
5. **资源优化**: 压缩和优化打包资源

### 7. 版本兼容性

- **Node.js**: >= 18.0.0
- **Electron**: >= 28.0.0
- **Windows**: 7/8/10/11 (x64)
- **依赖**: 确保所有依赖都支持Windows

### 8. 故障排除检查清单

- [ ] Node.js版本正确
- [ ] 依赖安装完成
- [ ] 图标文件存在
- [ ] 构建脚本权限正确
- [ ] 输出目录创建成功
- [ ] exe文件生成
- [ ] 安装程序能正常运行
- [ ] 应用启动无错误

如果仍有问题，请查看详细的构建日志或联系开发者。 